<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì s∆° c√° nh√¢n - JobPortal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50">
    <!-- Header Fragment -->
    <div data-fragment="fragments/header.html"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-6">
            <a href="index.html" class="hover:text-blue-600">Trang ch·ªß</a>
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-gray-900">Dashboard ·ª©ng vi√™n</span>
        </nav>

        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <!-- Profile Content -->
        <div id="profile-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Sidebar Fragment -->
                <div data-fragment="fragments/user-sidebar.html"></div>

                <!-- Main Content -->
                <div class="lg:col-span-3">
                    <!-- Profile Header -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex items-start justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <!-- Avatar with upload button -->
                                <div class="relative group">
                                    <img id="main-avatar" src="" alt="Avatar" class="w-16 h-16 rounded-full object-cover">
                                    <button onclick="document.getElementById('avatar-file-input').click()" class="absolute inset-0 bg-black bg-opacity-50 rounded-full opacity-0 group-hover:opacity-100 flex items-center justify-center transition duration-300 cursor-pointer">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                    <input type="file" id="avatar-file-input" accept="image/*" class="hidden">
                                </div>
                                <div>
                                    <h1 id="main-user-name" class="text-xl font-bold text-gray-900 mb-1"></h1>
                                    <p id="user-headline" class="text-blue-600 font-medium mb-2">Senior Frontend Developer</p>
                                    <div class="flex items-center gap-4 text-sm text-gray-600">
                                        <span id="user-phone" class="flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                                            </svg>
                                            <span id="phone-text">Ch∆∞a c·∫≠p nh·∫≠t</span>
                                        </span>
                                        <span id="user-address" class="flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span id="address-text">Ch∆∞a c·∫≠p nh·∫≠t</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="openEditProfileModal()" class="bg-blue-600 text-white py-2 px-4 rounded text-sm font-medium hover:bg-blue-700 transition">
                                Ch·ªânh s·ª≠a
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 pt-4">
                            <div>
                                <label class="text-xs font-medium text-gray-600 uppercase">H·ªç v√† t√™n</label>
                                <p id="info-name" class="text-gray-900 text-sm">Ch∆∞a c·∫≠p nh·∫≠t</p>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 uppercase">Email</label>
                                <p id="info-email" class="text-gray-900 text-sm">Ch∆∞a c·∫≠p nh·∫≠t</p>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 uppercase">Ti√™u ƒë·ªÅ ngh·ªÅ nghi·ªáp</label>
                                <p id="info-headline" class="text-gray-900 text-sm">Ch∆∞a c·∫≠p nh·∫≠t</p>
                            </div>
                        </div>
                    </div>

                    <!-- Introduction Section -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Gi·ªõi thi·ªáu</h2>
                            <button onclick="openEditSummaryModal()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                Ch·ªânh s·ª≠a
                            </button>
                        </div>
                        <p id="user-summary" class="text-gray-600 leading-relaxed">
                            Ch∆∞a c√≥ gi·ªõi thi·ªáu b·∫£n th√¢n.
                        </p>
                    </div>

                    <!-- Skills Section -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">K·ªπ nƒÉng</h2>
                        <div id="skills-container" class="flex flex-wrap gap-2">
                            <!-- Skills will be loaded here -->
                        </div>
                        <div id="no-skills" class="hidden text-gray-500 text-center py-4">
                            Ch∆∞a c√≥ k·ªπ nƒÉng n√†o ƒë∆∞·ª£c th√™m
                        </div>
                        <button onclick="openAddSkillModal()" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded text-sm font-medium hover:bg-blue-700 transition">
                            + Th√™m k·ªπ nƒÉng
                        </button>
                    </div>

                    <!-- Experience Section -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Kinh nghi·ªám l√†m vi·ªác</h2>
                        <div id="experience-container" class="space-y-6">
                            <!-- Experience will be loaded here -->
                        </div>
                        <div id="no-experience" class="hidden text-gray-500 text-center py-4">
                            Ch∆∞a c√≥ kinh nghi·ªám l√†m vi·ªác
                        </div>
                    </div>

                    <!-- Education Section -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">H·ªçc v·∫•n</h2>
                        <div id="education-container" class="space-y-6">
                            <!-- Education will be loaded here -->
                        </div>
                        <div id="no-education" class="hidden text-gray-500 text-center py-4">
                            Ch∆∞a c√≥ th√¥ng tin h·ªçc v·∫•n
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-20">
            <div class="text-red-500 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Kh√¥ng th·ªÉ t·∫£i h·ªì s∆°</h3>
            <p class="text-gray-600 mb-4">Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c ƒëƒÉng nh·∫≠p l·∫°i</p>
            <button onclick="loadProfile()" class="bg-blue-600 text-white px-4 py-2 rounded font-medium hover:bg-blue-700 transition">
                Th·ª≠ l·∫°i
            </button>
        </div>
    </main>

    <!-- Footer Fragment -->
    <div data-fragment="fragments/footer.html"></div>

    <!-- Add Skill Modal -->
    <div id="add-skill-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Th√™m k·ªπ nƒÉng</h2>
                <button onclick="closeAddSkillModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn k·ªπ nƒÉng</label>
                    <select id="skill-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Ch·ªçn k·ªπ nƒÉng --</option>
                    </select>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200">
                <button onclick="closeAddSkillModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    H·ªßy
                </button>
                <button onclick="saveSkill()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Th√™m k·ªπ nƒÉng
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Skill Modal -->
    <div id="edit-skill-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">X√≥a k·ªπ nƒÉng</h2>
                <button onclick="closeEditSkillModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <p class="text-gray-600">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·ªπ nƒÉng <strong id="delete-skill-name"></strong>?</p>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200">
                <button onclick="closeEditSkillModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    H·ªßy
                </button>
                <button onclick="confirmDeleteSkill()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    X√≥a
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Ch·ªânh s·ª≠a h·ªì s∆°</h2>
                <button onclick="closeEditProfileModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-4">
                <!-- Form Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n</label>
                        <input type="text" id="edit-name" placeholder="Nh·∫≠p h·ªç v√† t√™n" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="edit-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ</label>
                    <input type="text" id="edit-address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ ngh·ªÅ nghi·ªáp</label>
                    <input type="text" id="edit-headline" placeholder="VD: Senior Frontend Developer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200">
                <button onclick="closeEditProfileModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    H·ªßy
                </button>
                <button onclick="saveProfile()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Summary Modal -->
    <div id="edit-summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Ch·ªânh s·ª≠a gi·ªõi thi·ªáu</h2>
                <button onclick="closeEditSummaryModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gi·ªõi thi·ªáu b·∫£n th√¢n</label>
                    <div class="space-y-2">
                        <!-- Formatting Buttons -->
                        <div class="flex flex-wrap gap-2 mb-2">
                            <button type="button" onclick="insertSummaryMarkdown('**', '**')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded border border-gray-300 font-bold" title="Bold">B</button>
                            <button type="button" onclick="insertSummaryMarkdown('*', '*')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded border border-gray-300 italic" title="Italic">I</button>
                            <button type="button" onclick="insertSummaryMarkdown('~~', '~~')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded border border-gray-300 line-through" title="Strikethrough">S</button>
                            <button type="button" onclick="insertSummaryMarkdown('# ', '')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded border border-gray-300" title="Heading">H1</button>
                            <button type="button" onclick="insertSummaryMarkdown('## ', '')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded border border-gray-300" title="Heading 2">H2</button>
                            <button type="button" onclick="insertSummaryMarkdown('- ', '')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded border border-gray-300" title="List">List</button>
                            <button type="button" onclick="insertSummaryMarkdown('[', '](url)')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded border border-gray-300" title="Link">Link</button>
                            <span class="ml-2 text-xs text-gray-500 py-1">Markdown ƒë∆∞·ª£c h·ªó tr·ª£</span>
                        </div>
                        
                        <!-- Textarea -->
                        <textarea id="edit-summary-textarea" placeholder="Vi·∫øt gi·ªõi thi·ªáu ng·∫Øn v·ªÅ b·∫£n th√¢n. H·ªó tr·ª£ markdown: **bold**, *italic*, ~~strike~~, # heading, ## heading 2, - list, [link](url)" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                        
                        <!-- Preview Section -->
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <p class="text-xs font-semibold text-gray-600 mb-2">üëÅÔ∏è Preview:</p>
                            <div id="summary-preview" class="prose prose-sm max-w-none text-gray-700">
                                <p class="text-gray-400 italic">S·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200">
                <button onclick="closeEditSummaryModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    H·ªßy
                </button>
                <button onclick="saveSummary()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/fragments-loader.js"></script>
    <script src="js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script>
        let userProfile = null;
        let userSkills = [];
        let userResumes = [];
        let allAvailableSkills = []; // Store all available skills from public API
        let currentEditingSkillSlug = null; // Track which skill is being edited

        // Load all profile data
        async function loadProfile() {
            try {
                showLoading();
                
                // Check authentication
                if (!authService.isAuthenticated()) {
                    window.location.href = 'login.html';
                    return false;
                }

                // Load all data in parallel
                const [profileResponse, skillsResponse, resumesResponse, availableSkillsResponse] = await Promise.all([
                    loadUserProfile(),
                    loadUserSkills(),
                    loadUserResumes(),
                    loadAvailableSkills()
                ]);

                if (profileResponse && skillsResponse && resumesResponse && availableSkillsResponse) {
                    displayProfile();
                    hideLoading();
                    return true;
                } else {
                    showError();
                    return false;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showError();
                return false;
            }
        }

        // Load user profile data
        async function loadUserProfile() {
            try {
                const token = authService.getToken();
                const response = await fetch('http://localhost:8080/api/users/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    userProfile = result.data;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading user profile:', error);
                return false;
            }
        }

        // Load user skills
        async function loadUserSkills() {
            try {
                const token = authService.getToken();
                const response = await fetch('http://localhost:8080/api/users/skills', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    userSkills = result.data;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading user skills:', error);
                return false;
            }
        }

        // Load user resumes
        async function loadUserResumes() {
            try {
                const token = authService.getToken();
                const response = await fetch('http://localhost:8080/api/resumes/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    userResumes = result.data;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading user resumes:', error);
                return false;
            }
        }

        // Load all available skills from public API
        async function loadAvailableSkills() {
            try {
                const response = await fetch('http://localhost:8080/api/skills/list', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    allAvailableSkills = result.data;
                    populateSkillSelect();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading available skills:', error);
                return false;
            }
        }

        // Display profile data
        function displayProfile() {
            // User profile info
            if (userProfile) {
                // Update sidebar elements (if they exist from fragment)
                const sidebarUserName = document.getElementById('sidebar-user-name');
                if (sidebarUserName) {
                    sidebarUserName.textContent = userProfile.name || 'Ch∆∞a c·∫≠p nh·∫≠t';
                }
                
                const sidebarUserEmail = document.getElementById('sidebar-user-email');
                if (sidebarUserEmail) {
                    sidebarUserEmail.textContent = userProfile.email || 'Ch∆∞a c·∫≠p nh·∫≠t';
                }

                // Update main profile elements
                document.getElementById('main-user-name').textContent = userProfile.name || 'Ch∆∞a c·∫≠p nh·∫≠t';
                
                // Update user info card elements
                document.getElementById('info-name').textContent = userProfile.name || 'Ch∆∞a c·∫≠p nh·∫≠t';
                document.getElementById('info-email').textContent = userProfile.email || 'Ch∆∞a c·∫≠p nh·∫≠t';
                document.getElementById('info-headline').textContent = userProfile.headline || 'Ch∆∞a c·∫≠p nh·∫≠t';
                
                // Update header phone and address
                document.getElementById('phone-text').textContent = userProfile.phone || 'Ch∆∞a c·∫≠p nh·∫≠t';
                document.getElementById('address-text').textContent = userProfile.address || 'Ch∆∞a c·∫≠p nh·∫≠t';
                
                // Headline
                const headlineElement = document.getElementById('user-headline');
                if (headlineElement) {
                    if (userProfile.headline) {
                        headlineElement.textContent = userProfile.headline;
                    } else {
                        headlineElement.textContent = 'Senior Frontend Developer';
                    }
                }
                
                // Avatar - update main avatar and sidebar avatar if they exist
                const mainAvatar = document.getElementById('main-avatar');
                if (mainAvatar) {
                    if (userProfile.avatarUrl) {
                        mainAvatar.src = `http://localhost:8080${userProfile.avatarUrl}`;
                    } else {
                        mainAvatar.src = 'https://via.placeholder.com/80/6B7280/FFFFFF?text=' + (userProfile.name ? userProfile.name.charAt(0) : 'U');
                    }
                }

                const sidebarAvatar = document.getElementById('sidebar-user-avatar');
                if (sidebarAvatar) {
                    if (userProfile.avatarUrl) {
                        sidebarAvatar.src = `http://localhost:8080${userProfile.avatarUrl}`;
                    } else {
                        sidebarAvatar.src = 'https://via.placeholder.com/80/6B7280/FFFFFF?text=' + (userProfile.name ? userProfile.name.charAt(0) : 'U');
                    }
                }

                // Summary - use default if not available
                const summaryElement = document.getElementById('user-summary');
                if (userProfile.summary) {
                    summaryElement.innerHTML = DOMPurify.sanitize(marked.parse(userProfile.summary));
                } else {
                    summaryElement.textContent = 'Ch∆∞a c√≥ gi·ªõi thi·ªáu b·∫£n th√¢n.';
                }
            }

            // Display skills
            displaySkills();

            // Display experience and education from resumes
            displayExperienceAndEducation();
        }

        // Display skills as tags with delete buttons
        function displaySkills() {
            const skillsContainer = document.getElementById('skills-container');
            const noSkillsElement = document.getElementById('no-skills');

            if (userSkills.length === 0) {
                skillsContainer.classList.add('hidden');
                noSkillsElement.classList.remove('hidden');
                return;
            }

            skillsContainer.classList.remove('hidden');
            noSkillsElement.classList.add('hidden');

            skillsContainer.innerHTML = userSkills.map(skill => `
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    ${skill.name}
                    <button onclick="deleteSkillDirect('${skill.slug}')" class="text-blue-600 hover:text-blue-900 transition" title="X√≥a k·ªπ nƒÉng">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </span>
            `).join('');
        }

        // Display experience and education from resume data
        function displayExperienceAndEducation() {
            displayExperience();
            displayEducation();
        }

        // Display experience
        function displayExperience() {
            const experienceContainer = document.getElementById('experience-container');
            const noExperienceElement = document.getElementById('no-experience');

            // Get all experiences from all resumes
            let allExperiences = [];
            userResumes.forEach(resume => {
                if (resume.experiences) {
                    allExperiences = allExperiences.concat(resume.experiences);
                }
            });

            if (allExperiences.length === 0) {
                experienceContainer.classList.add('hidden');
                noExperienceElement.classList.remove('hidden');
                return;
            }

            experienceContainer.classList.remove('hidden');
            noExperienceElement.classList.add('hidden');

            experienceContainer.innerHTML = allExperiences.map(exp => `
                <div class="border-l-4 border-blue-500 pl-4">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="font-semibold text-gray-900">${exp.position}</h3>
                            <p class="text-blue-600 font-medium">${exp.company}</p>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <p>${formatDate(exp.startDate)} - ${exp.current ? 'Hi·ªán t·∫°i' : formatDate(exp.endDate)}</p>
                            ${exp.current ? '<span class="text-green-600 text-xs">‚óè ƒêang l√†m vi·ªác</span>' : ''}
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm">${exp.description || 'Ch∆∞a c√≥ m√¥ t·∫£ c√¥ng vi·ªác'}</p>
                </div>
            `).join('');
        }

        // Display education
        function displayEducation() {
            const educationContainer = document.getElementById('education-container');
            const noEducationElement = document.getElementById('no-education');

            // Get all educations from all resumes
            let allEducations = [];
            userResumes.forEach(resume => {
                if (resume.educations) {
                    allEducations = allEducations.concat(resume.educations);
                }
            });

            if (allEducations.length === 0) {
                educationContainer.classList.add('hidden');
                noEducationElement.classList.remove('hidden');
                return;
            }

            educationContainer.classList.remove('hidden');
            noEducationElement.classList.add('hidden');

            educationContainer.innerHTML = allEducations.map(edu => `
                <div class="border-l-4 border-green-500 pl-4">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="font-semibold text-gray-900">${edu.degree || 'Ch∆∞a c·∫≠p nh·∫≠t'}</h3>
                            <p class="text-green-600 font-medium">${edu.school || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <p>${edu.startDate ? formatDate(edu.startDate) : 'Ch∆∞a c·∫≠p nh·∫≠t'} - ${edu.endDate ? formatDate(edu.endDate) : 'Hi·ªán t·∫°i'}</p>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm">Chuy√™n ng√†nh: ${edu.major || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                </div>
            `).join('');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Ch∆∞a c·∫≠p nh·∫≠t';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Get file type name
        function getFileTypeName(fileType) {
            switch (fileType) {
                case 'PORTFOLIO': return 'Portfolio';
                case 'CV': return 'CV';
                case 'CERTIFICATE': return 'Ch·ª©ng ch·ªâ';
                default: return 'T√†i li·ªáu';
            }
        }

        // UI helper functions
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('profile-content').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('profile-content').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('profile-content').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadFragments().then(() => {
                setupAvatarUpload();
                loadProfile().then(() => {
                    // After profile loads, call sidebar functions to populate sidebar
                    if (typeof loadSidebarUserInfo === 'function') {
                        loadSidebarUserInfo();
                    }
                    if (typeof highlightActiveMenu === 'function') {
                        highlightActiveMenu();
                    }
                });
            });
        });

        // Setup avatar upload handler
        function setupAvatarUpload() {
            const avatarFileInput = document.getElementById('avatar-file-input');
            avatarFileInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
                        avatarFileInput.value = '';
                        return;
                    }

                    // Show loading state
                    const avatar = document.getElementById('main-avatar');
                    const originalSrc = avatar.src;
                    
                    // Upload avatar
                    const uploadSuccess = await uploadAvatar(file);
                    if (uploadSuccess) {
                        // Update avatar display immediately
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            avatar.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        
                        // Also update sidebar avatar if it exists
                        const sidebarAvatar = document.getElementById('sidebar-user-avatar');
                        if (sidebarAvatar) {
                            sidebarAvatar.src = avatar.src;
                        }
                        
                        alert('C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng');
                    } else {
                        avatar.src = originalSrc;
                    }
                    
                    // Clear file input
                    avatarFileInput.value = '';
                }
            });
        }

        // Open edit profile modal
        function openEditProfileModal() {
            if (!userProfile) return;

            // Populate form with current data
            document.getElementById('edit-name').value = userProfile.name || '';
            document.getElementById('edit-phone').value = userProfile.phone || '';
            document.getElementById('edit-address').value = userProfile.address || '';
            document.getElementById('edit-headline').value = userProfile.headline || '';

            document.getElementById('edit-profile-modal').classList.remove('hidden');
        }

        // Close edit profile modal
        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        }

        // Open edit summary modal
        function openEditSummaryModal() {
            if (!userProfile) return;

            // Populate textarea with current summary
            document.getElementById('edit-summary-textarea').value = userProfile.summary || '';
            
            // Update preview
            updateEditSummaryPreview();

            document.getElementById('edit-summary-modal').classList.remove('hidden');
        }

        // Close edit summary modal
        function closeEditSummaryModal() {
            document.getElementById('edit-summary-modal').classList.add('hidden');
        }

        // Save profile changes
        async function saveProfile() {
            try {
                const name = document.getElementById('edit-name').value.trim();
                const phone = document.getElementById('edit-phone').value.trim();
                const address = document.getElementById('edit-address').value.trim();
                const headline = document.getElementById('edit-headline').value.trim();

                // Validation
                if (!name) {
                    alert('Vui l√≤ng nh·∫≠p h·ªç v√† t√™n');
                    return;
                }

                // Update profile
                const updateSuccess = await updateProfile({
                    name,
                    phone,
                    address,
                    headline
                });

                if (updateSuccess) {
                    alert('C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng');
                    closeEditProfileModal();
                    // Reload page to get fresh data
                    location.reload();
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u h·ªì s∆°');
            }
        }

        // Upload avatar
        async function uploadAvatar(file) {
            try {
                const token = authService.getToken();
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('http://localhost:8080/api/users/avatar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert(errorData.message || 'L·ªói khi t·∫£i l√™n ·∫£nh');
                    return false;
                }

                const result = await response.json();
                if (result.success) {
                    // Update userProfile with new avatar
                    userProfile.avatarUrl = result.data.avatarUrl;
                    return true;
                } else {
                    alert(result.message || 'L·ªói khi t·∫£i l√™n ·∫£nh');
                    return false;
                }
            } catch (error) {
                console.error('Error uploading avatar:', error);
                alert('L·ªói khi t·∫£i l√™n ·∫£nh');
                return false;
            }
        }

        // Update profile
        async function updateProfile(profileData) {
            try {
                const token = authService.getToken();
                const response = await fetch('http://localhost:8080/api/users/profile/me', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert(errorData.message || 'L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°');
                    return false;
                }

                const result = await response.json();
                if (result.success) {
                    userProfile = result.data;
                    return true;
                } else {
                    alert(result.message || 'L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°');
                    return false;
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°');
                return false;
            }
        }

        // Populate skill select dropdown with available skills
        function populateSkillSelect() {
            const skillSelect = document.getElementById('skill-select');
            
            // Filter out skills that are already added
            const addedSkillSlugs = userSkills.map(s => s.slug);
            const availableSkillsNotAdded = allAvailableSkills.filter(s => !addedSkillSlugs.includes(s.slug));
            
            // Clear existing options except the default one
            skillSelect.innerHTML = '<option value="">-- Ch·ªçn k·ªπ nƒÉng --</option>';
            
            availableSkillsNotAdded.forEach(skill => {
                const option = document.createElement('option');
                option.value = skill.slug;
                option.textContent = skill.name;
                skillSelect.appendChild(option);
            });
        }

        // Open add skill modal
        function openAddSkillModal() {
            populateSkillSelect();
            document.getElementById('skill-select').value = '';
            document.getElementById('add-skill-modal').classList.remove('hidden');
        }

        // Close add skill modal
        function closeAddSkillModal() {
            document.getElementById('add-skill-modal').classList.add('hidden');
        }

        // Save new skill
        async function saveSkill() {
            try {
                const skillSlug = document.getElementById('skill-select').value.trim();

                if (!skillSlug) {
                    alert('Vui l√≤ng ch·ªçn k·ªπ nƒÉng');
                    return;
                }

                const token = authService.getToken();
                const response = await fetch(`http://localhost:8080/api/users/skills/${skillSlug}?yearsExperience=0`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert(errorData.message || 'L·ªói khi th√™m k·ªπ nƒÉng');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    alert('Th√™m k·ªπ nƒÉng th√†nh c√¥ng');
                    closeAddSkillModal();
                    // Reload skills
                    await loadUserSkills();
                    displaySkills();
                } else {
                    alert(result.message || 'L·ªói khi th√™m k·ªπ nƒÉng');
                }
            } catch (error) {
                console.error('Error saving skill:', error);
                alert('L·ªói khi th√™m k·ªπ nƒÉng');
            }
        }

        // Open edit skill modal
        function openEditSkillModal(skillSlug, skillName) {
            currentEditingSkillSlug = skillSlug;
            document.getElementById('delete-skill-name').textContent = skillName;
            document.getElementById('edit-skill-modal').classList.remove('hidden');
        }

        // Close edit skill modal
        function closeEditSkillModal() {
            currentEditingSkillSlug = null;
            document.getElementById('edit-skill-modal').classList.add('hidden');
        }

        // Delete skill directly from tag
        async function deleteSkillDirect(skillSlug) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·ªπ nƒÉng n√†y?')) {
                return;
            }
            await performDeleteSkill(skillSlug);
        }

        // Confirm delete from modal
        async function confirmDeleteSkill() {
            if (!currentEditingSkillSlug) {
                alert('L·ªói: Kh√¥ng th·ªÉ x√°c ƒë·ªãnh k·ªπ nƒÉng c·∫ßn x√≥a');
                return;
            }
            await performDeleteSkill(currentEditingSkillSlug);
        }

        // Perform the actual delete operation
        async function performDeleteSkill(skillSlug) {
            try {
                const token = authService.getToken();
                const response = await fetch(`http://localhost:8080/api/users/skills/${skillSlug}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert(errorData.message || 'L·ªói khi x√≥a k·ªπ nƒÉng');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    alert('X√≥a k·ªπ nƒÉng th√†nh c√¥ng');
                    closeEditSkillModal();
                    // Reload skills
                    await loadUserSkills();
                    displaySkills();
                } else {
                    alert(result.message || 'L·ªói khi x√≥a k·ªπ nƒÉng');
                }
            } catch (error) {
                console.error('Error deleting skill:', error);
                alert('L·ªói khi x√≥a k·ªπ nƒÉng');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const addSkillModal = document.getElementById('add-skill-modal');
            const editSkillModal = document.getElementById('edit-skill-modal');
            const editProfileModal = document.getElementById('edit-profile-modal');
            
            if (event.target === addSkillModal) {
                closeAddSkillModal();
            }
            if (event.target === editSkillModal) {
                closeEditSkillModal();
            }
            if (event.target === editProfileModal) {
                closeEditProfileModal();
            }
            const editSummaryModal = document.getElementById('edit-summary-modal');
            if (event.target === editSummaryModal) {
                closeEditSummaryModal();
            }
        });

        // Insert markdown syntax in summary textarea
        function insertSummaryMarkdown(before, after) {
            const textarea = document.getElementById('edit-summary-textarea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end) || 'text';
            
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            
            textarea.value = beforeText + before + selectedText + after + afterText;
            textarea.focus();
            textarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
            
            updateEditSummaryPreview();
        }

        // Update markdown preview for edit summary modal
        function updateEditSummaryPreview() {
            const summaryText = document.getElementById('edit-summary-textarea').value;
            const previewElement = document.getElementById('summary-preview');
            
            if (summaryText) {
                const htmlContent = DOMPurify.sanitize(marked.parse(summaryText));
                previewElement.innerHTML = htmlContent;
            } else {
                previewElement.innerHTML = '<p class="text-gray-400 italic">S·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>';
            }
        }

        // Save summary changes
        async function saveSummary() {
            try {
                const summary = document.getElementById('edit-summary-textarea').value.trim();

                // Update profile with summary only
                const updateSuccess = await updateProfile({
                    summary
                });

                if (updateSuccess) {
                    alert('C·∫≠p nh·∫≠t gi·ªõi thi·ªáu th√†nh c√¥ng');
                    closeEditSummaryModal();
                    // Reload page to get fresh data
                    location.reload();
                }
            } catch (error) {
                console.error('Error saving summary:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u gi·ªõi thi·ªáu');
            }
        }

        // Add event listener for summary textarea to update preview
        document.addEventListener('DOMContentLoaded', function() {
            const summaryTextarea = document.getElementById('edit-summary-textarea');
            if (summaryTextarea) {
                summaryTextarea.addEventListener('input', updateEditSummaryPreview);
            }
        }, { once: true });
    </script>
</body>
</html>